{% extends "profiles/base_profile_edit.html" %}

{% load provider_login_url from socialaccount %}
{% load i18n %}

{% block title %}{% trans "Migrate account to GitHub App" %}{% endblock %}

{% block profile-admin-tokens %}active{% endblock %}

{% block edit_content_header %} {% trans "Migrate account to GitHub App" %} {% endblock %}

{% block edit_content %}
<ol>
  <li>
    Connect your account to the new GitHub app:

    {% url "migrate_to_github_app" as migrate_to_github_app_url %}
    <form
      method="post"
      action="{% provider_login_url gh_app_provider.id process="connect" next=migrate_to_github_app_url %}">
      {% csrf_token %}
      <button
          class="socialaccount-provider {{ gh_app_provider.id }} button"
          type="submit"
          title="{{ gh_app_provider.name }}"
          {% if has_gh_app_social_account %}disabled{% endif %}>
        {% trans "Connect" %}
      </button>
    </form>
  </li>
  <li>
    Install app in all your repositories connected to a project:

    {% if installation_target_groups %}
      <ul>
      {% for installation_target_group in installation_target_groups %}
      <li>
        {{ installation_target_group.target_name }} ({{ installation_target_group.target_type }}):
        {% if installation_target_group.installed %}
        <span>installed</span>
        {% else %}
        <a href="{{ installation_target_group.link }}" target="_blank">
          install
        </a>
        {% endif %}
      </li>
      {% endfor %}
      </ul>

      Or install one by one in the next step
    {% else %}
      <p>
        You have already granted access to all your repositories.
      </p>
    {% endif %}
  </li>

  <li>
    Migrate your projects to the GH app:

    <ul>
      <li>
        <form method="post" action=".">
          {% csrf_token %}
          <button type="submit">Migrate all</button>
        </form>
      </li>
    </ul>

    Or migrate one by one:

    <ul>
      {% for migration_target in migration_targets %}
      <li>
        <a href="{% url 'projects_edit' migration_target.project.slug %}">
          {{ migration_target.project.name }}
        </a>
        -&gt;

        <a href="{{ migration_target.project.remote_repository.html_url }}">
          {{ migration_target.project.remote_repository.full_name }}
        </a>
        :

        {% if not migration_target.has_installation %}
          <a href="{{ migration_target.installation_link }}" target="_blank">
            Install
          </a>
        {% else %}
        <form method="post" action=".">
          {% csrf_token %}
          <input type="hidden" name="project" value="{{ migration_target.project.slug }}">
          <button
            type="submit"
            {% if not migration_target.is_admin %}
            title="You need to have admin access to the repository"
            disabled
            {% endif %}>
            Migrate
          </button>
        </form>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </li>

  <li>
    <a href="{{ old_application_link }}" target="_blank">
      Revoke access to the old GH OAuth app from your account
    </a>
  </li>

  <li>
    Disconnect the old GH app from your RTD account:

    <form
      method="post"
        {# TODO: where do we redirect? #}
      action="{% provider_login_url gh_provider.id process="disconnect" next=migrate_to_github_app_url %}">
      {% csrf_token %}
      <button
          class="socialaccount-provider {{ gh_provider.id }} button"
          type="submit"
          title="{{ gh_provider.name }}">
        {# TODO: warm when pressing this button #}
        {% trans "Disconnect" %}
      </button>
    </form>
  </li>
</ol>
{% endblock %}
